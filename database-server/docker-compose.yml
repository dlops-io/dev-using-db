version: "3.8"
services:
    # we have two services here, jordandb-client and jordandb-server
    # this client depends on the server
    dev-using-db-client:
        # source: https://github.com/amacneil/dbmate#postgresql
        # Dbmate is a database migration tool, to keep your database schema in sync across multiple developers and your production servers
        # keeps track of migrations, and runs it in an order; the power of dbmate is to manage migrations of the script; Shivas uses DataGrip to manage; “dbmate rollback” removes stuff; “dbmate up” creates the table; When we run this “sh ./docker-shell.sh”, I can get the same database setup as Shivas on his end
        image: amacneil/dbmate
        container_name: dev-using-db-client
        entrypoint: /bin/sh
        depends_on:
            - dev-using-db-server
        # source: https://docs.docker.com/storage/volumes/
        # Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. While bind mounts are dependent on the directory structure and OS of the host machine, volumes are completely managed by Docker
        volumes:
            - ./db:/db
        environment:
            DATABASE_URL: "postgres://test:welcome123@dev-using-db-server:5432/dev-using-db\
                ?sslmode=disable"
    dev-using-db-server:
        # The database is for the metadata (e.g. when a model predicts, keep track of the prediction results)
        image: postgres
        container_name: dev-using-db-server
        # we are creating the database (/var/lib/postgresql/data), and that will be mounted to our local machine so that we have access to it, inside the database-server/docker-volumes/postgres folder
        volumes:
            - ./docker-volumes/postgres:/var/lib/postgresql/data
        ports:
            - 5432:5432
        environment:
            POSTGRES_USER: test
            POSTGRES_PASSWORD: welcome123
            POSTGRES_DB: dev-using-db
        command: -p 5432
networks:
    default:
        external:
            name: dev-using-db
